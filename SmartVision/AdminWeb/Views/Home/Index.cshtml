@{
    ViewBag.Title = "Smart Vision Admin";
}

<div class="row">
    <div class="col-sm-8" id="streams">
        <div id="streamWrapper" class="row no-gutters"></div>
    </div>
    <div class="col-sm-4">
        <h3>Add another camera</h3>
        @Html.Label("URL: ")
        @Html.TextBox("streamURL", null, new { @class = "form-control", @type = "text", @id = "streamURL" })
        <label>@Html.RadioButton("streamType", "mjpeg", true) MJPEG stream</label>
        <label>@Html.RadioButton("streamType", "jpeg", false) JPEG stream</label>
        <input class="btn btn-primary form-control" type="submit" id="submit" value="Add">
    </div>

</div>
<style>
    html {
        overflow-y: scroll;
    }

    .faceDetected {
        display: none;
        position: absolute;
        left: 1%;
        bottom: 0;
        font-size: 3em;
        -webkit-text-fill-color: white;
        -webkit-text-stroke-width: 1px;
        -webkit-text-stroke-color: black;
    }

    .imgThumbnail > img {
        cursor: pointer;
        border: 1px solid black;
        height: 100%;
        object-fit: cover;
    }

    #imgSelected > img {
        border: 1px solid black;
    }

    #imgSelected {
        position: relative;
    }

    img {
        width: 100%;
    }

    .hoverableButton {
        overflow: hidden;
        position: absolute;
        top: 0%;
        opacity: 0;
        transition: opacity .35s ease;
        border-radius: 0;
        color: white !important;
        text-align: center;
        width: 10%;
    }

    .removeButton {
        left: 80%;
    }

    .closeButton {
        left: 90%;
    }

    #imgSelected:hover > .hoverableButton {
        opacity: 1;
    }

    #submit {
        margin-top: 3%;
    }
</style>

@section scripts
{
    @Scripts.Render("~/Scripts/jquery.signalR-2.2.2.js")
    <script src="~/signalr/hubs"></script>
    <script>
        $(function () {

            var alerter = $.connection.faceDetectedAlert;

            console.log(alerter);
            console.log($.connection);

            alerter.client.alertFaceDetected = function (ids) {
                ids.forEach(function (id) {
                    $('#' + id + '> span').stop();
                    $('#' + id + '> span').show(0).delay(5000).hide(0);
                });
            }

            $.connection.hub.start({ transport: 'longPolling' }, function () {
                console.log('connection started!');
            });

        });

        $(document).ready(function() {
            $.ajax({
                url: '@Url.Action("GetStreamList", "Home")',
                type: 'GET',
                dataType: "json",
                success: function (data) {
                    data.result.forEach(function (streamTuple) {
                        var stream = {
                            url: streamTuple.Item1,
                            id: streamTuple.Item2
                        };
                        addStream(stream);
                    });
                },
                error: function () {
                    alert('Error POST');
                }
            });
        });

        function removeStream(element) {
            if (!confirm("Are you sure yout want to remove this stream & stop processing its camera feed?"))
                return;
            id = $(element).data('id')
            $.ajax({
                url: '@Url.Action("RemoveStream", "Home")',
                type: 'POST',
                dataType: "json",
                data: { streamId: id },
                success: function (data) {
                    $('#' + id).remove();
                    $(element).parent().remove();
                },
                error: function () {
                    alert('Error remove POST');
                }
            });
        };

        function selectStream(streamElement) {
            streamElement.w
            $('#imgSelected').remove();
            $('#streams').append(
                '<div id="imgSelected">' +
                '<img src="' + $(streamElement).children('img').attr('src') + '" /> ' +
                '<button data-id="' + streamElement.id + '"class="btn btn-square btn-danger hoverableButton removeButton" onclick="removeStream(this)">' +
                '<span class="fa fa-ban"></span>' +
                '</button>' +
                '<button data-id="' + streamElement.id + '"class="btn btn-square btn-warning hoverableButton closeButton" onclick="$(this).parent().remove()">' +
                '<span class="fa fa-times"></span>' +
                '</button>' +
                '</div>'
            );
        }

        function addStream(stream) {
            $("#streamWrapper").append(
                '<div class="imgThumbnail col-sm-4" onclick=selectStream(this) id="' + stream.id + '">' +
                '<span class="fa fa-user faceDetected"></span>' +
                '<img src="' + stream.url + '"/> ' +
                '</div>'
            );
        }

        $("#submit").click(function () {
            var streamUrl = $('#streamURL').val();
            var streamType = $('input[name=streamType]:checked').val();
            console.log(streamType);
            if (streamUrl === "")
                return;
            $.ajax({
                url: '@Url.Action("AddCamera", "Home")',
                type: 'POST',
                dataType: "json",
                data: { streamUrl: streamUrl, streamType: streamType },
                success: function (streamData) {
                    $('#streamUrl').val('');
                    addStream(streamData);
                },
                error: function () {
                    alert('Error add POST');
                }
            });
        });
    </script>

}
