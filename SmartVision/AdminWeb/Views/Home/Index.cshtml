@{
    ViewBag.Title = "Smart Vision Admin";
}

<div class="row">
    <div class="col-sm-8" id="streamWrapper">
    </div>
    <div class="col-sm-4">
        <h3>Add another camera</h3>
        @Html.Label("URL: ")
        @Html.TextBox("streamURL", null, new { @class = "form-control", @type = "text", @id = "streamURL" })
        <input class="btn btn-primary" type="submit" id="submit" value="Add">
    </div>

</div>
<style>
    .hoverContainer {
        position: relative;
        margin-top: 50px;
        width: 300px;
        height: 200px;
    }

    .overlayHover {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0);
        transition: background 0.5s ease;
    }

    .hoverContainer:hover #overlay {
        display: block;
        background: rgba(0, 0, 0, .3);
    }

    .hoverableButton {
        position: absolute;
        width: 15%;
        left: 85%;
        top: 0%;
        opacity: 0;
        transition: opacity .35s ease;
        border-radius: 0;
    }

    .hoverableButton a {
        width: 10%;
        text-align: center;
        color: white;
        border: solid 2px white;
        z-index: 1;
    }

    .hoverContainer:hover .hoverableButton {
        opacity: 1;
    }
</style>

@section scripts
{
    @Scripts.Render("~/Scripts/jquery.signalR-2.2.2.js")
    <script src="~/signalr/hubs"></script>
    <script>
        $(function () {

            var alerter = $.connection.faceDetectedAlert;

            console.log(alerter);
            console.log($.connection);           

            alerter.client.alertFaceDetected = function (ids) {
                /* handle the fact that face detected in camera with id */
                ids.forEach(function (id) {
                    console.log(id);
                });
            }

            $.connection.hub.start({ transport: 'longPolling' }, function () {
                console.log('connection started!');
            });

            //$.connection.hub.start().done(init);

        });

        $('#isBus').change(function () {
            $('#cameraForm').toggle();
            $('#bussForm').toggle();
        });

        $(document).ready(function() {
            $.ajax({
                url: '@Url.Action("GetStreamList", "Home")',
                type: 'GET',
                dataType: "json",
                success: function (data) {
                    data.result.forEach(function (streamTuple) {
                        var stream = {
                            url: streamTuple.Item1,
                            id: streamTuple.Item2
                        };
                        addStream(stream);
                    });
                },
                error: function () {
                    alert('Error POST');
                }
            });
        });

        function removeStream(element) {
            $.ajax({
                url: '@Url.Action("RemoveStream", "Home")',
                type: 'POST',
                dataType: "json",
                data: { streamId: JSON.stringify($(element).data('id')) },
                success: function (data) {
                    $(element).parent().remove();
                },
                error: function () {
                    alert('Error remove POST');
                }
            });
        };

        function addStream(stream) {
            $("#streamWrapper").append('<div class="hoverContainer" data-id="' + stream.id + '">' +
                '<img src="' + stream.url + '" height="200" width="300" /> ' +
                '<div class="overlay"></div>  ' +
                '<button data-id="' + stream.id + '"class="btn btn-square btn-danger hoverableButton" onclick="removeStream(this)">' +
                'X' +
                '</button>' +
                '</div>');
        }

        $("#submit").click(function () {
            var streamUrl = document.getElementById('streamURL').value;
            console.log(streamUrl);
            $.ajax({
                url: '@Url.Action("AddCamera", "Home")',
                type: 'POST',
                dataType: "json",
                data: { streamUrl: JSON.stringify(streamUrl) },
                success: function (streamData) {
                    $(':input').not('#submit').val('');
                    addStream(streamData);
                },
                error: function () {
                    alert('Error add POST');
                }
            });
        });
    </script>

}
